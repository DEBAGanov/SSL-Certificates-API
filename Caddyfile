# /**
#  * @file: Caddyfile
#  * @description: Конфигурация Caddy для Timeweb App Platform
#  * @created: 2025-12-05
#  */

# =============================================================================
# ГЛОБАЛЬНЫЕ НАСТРОЙКИ
# =============================================================================
{
    # Отключаем автоматический HTTPS - платформа сама управляет SSL
    auto_https off
    
    # Слушаем на порту 80
    http_port 80
}

# =============================================================================
# Основной обработчик - проксирование на backend серверы
# =============================================================================

:80 {
    # Логирование
    log {
        output stdout
        format json
    }
    
    # Сжатие
    encode gzip zstd
    
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        -Server
    }
    
    # Роутинг по Host header
    @dimbopizza host dimbopizza.ru www.dimbopizza.ru
    handle @dimbopizza {
        reverse_proxy http://2.59.42.195:80 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    @antaliya host antaliya.volzhck.ru
    handle @antaliya {
        reverse_proxy http://31.130.147.150:80 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    @api host api.volzhck.ru
    handle @api {
        reverse_proxy http://31.130.147.150:80 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    @dimbo host dimbo.volzhck.ru
    handle @dimbo {
        reverse_proxy http://31.130.147.150:80 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    @dodopizza host dodopizza.volzhck.ru
    handle @dodopizza {
        reverse_proxy http://31.130.147.150:80 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    # Дефолтный ответ для проверки работоспособности
    handle {
        respond "Caddy SSL Proxy is running" 200
    }
}
