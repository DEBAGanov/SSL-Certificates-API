# /**
#  * @file: Caddyfile
#  * @description: Конфигурация Caddy для автоматических SSL сертификатов
#  * @dependencies: docker-compose.yml
#  * @created: 2025-12-05
#  */

# =============================================================================
# ГЛОБАЛЬНЫЕ НАСТРОЙКИ
# =============================================================================
{
    # Email для Let's Encrypt уведомлений
    email baganov.v@gmail.com
    
    # Использовать production Let's Encrypt
    acme_ca https://acme-v02.api.letsencrypt.org/directory
    
    # Для тестирования раскомментируйте staging (без лимитов):
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
    
    # Глобальное логирование
    log {
        output stdout
        format json
        level INFO
    }
}

# =============================================================================
# ОБЩИЕ СНИППЕТЫ
# =============================================================================

# Сниппет для security headers
(security_headers) {
    header {
        # HSTS - принудительный HTTPS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Защита от MIME sniffing
        X-Content-Type-Options "nosniff"
        # Защита от clickjacking
        X-Frame-Options "SAMEORIGIN"
        # XSS защита
        X-XSS-Protection "1; mode=block"
        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"
        # Удаляем заголовок Server
        -Server
    }
}

# Сниппет для сжатия
(compression) {
    encode gzip zstd
}

# Сниппет для логирования запросов
(access_log) {
    log {
        output stdout
        format json
    }
}

# =============================================================================
# ДОМЕН: dimbopizza.ru
# IP: 2.59.42.195
# =============================================================================
dimbopizza.ru {
    import security_headers
    import compression
    import access_log
    
    reverse_proxy http://2.59.42.195:80 {
        # Health check
        health_uri /
        health_interval 30s
        health_timeout 5s
        
        # Заголовки для backend
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# =============================================================================
# ДОМЕНЫ НА СЕРВЕРЕ: 31.130.147.150
# antaliya.volzhck.ru, api.volzhck.ru, dimbo.volzhck.ru, dodopizza.volzhck.ru
# =============================================================================

# Antaliya
antaliya.volzhck.ru {
    import security_headers
    import compression
    import access_log
    
    reverse_proxy http://31.130.147.150:80 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# API
api.volzhck.ru {
    import security_headers
    import compression
    import access_log
    
    reverse_proxy http://31.130.147.150:80 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Dimbo
dimbo.volzhck.ru {
    import security_headers
    import compression
    import access_log
    
    reverse_proxy http://31.130.147.150:80 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Dodopizza
dodopizza.volzhck.ru {
    import security_headers
    import compression
    import access_log
    
    reverse_proxy http://31.130.147.150:80 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# =============================================================================
# ПРИМЕЧАНИЯ
# =============================================================================
# 
# Для добавления нового домена:
# 1. Добавьте A-запись в DNS, указывающую на IP сервера с Caddy
# 2. Добавьте блок конфигурации по шаблону выше
# 3. Перезапустите Caddy: docker compose restart caddy
#
# Для проверки конфигурации:
# docker compose exec caddy caddy validate --config /etc/caddy/Caddyfile
#
# Для просмотра логов:
# docker compose logs -f caddy
#
# =============================================================================

